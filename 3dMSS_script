# This 3dMSS script compares HRFs between the two groups at the population level
# Each HRF at the indiividual level is characterized at 14 time points with a
# time resolution TR = 1.25s. Two covariates are considered: sex and age.

3dMSS -prefix output                      \
      -jobs 16                            \
      -lme ‘sex+age+s(TR)+s(TR,by=group)’ \
      -ranEff ‘list(subject=~1)’          \
      -qVars ‘sex,age,TR,group’           \
      -prediction @HRF.table              \
      -dataTable  @input.table

# The output filename and number of CPUs for parallelization are specified through -prefix and -jobs, 
# respectively. The expression s() in the model specification -lme represents the smooth function, and 
# the two terms s(TR), s(TR,by=group) code the overall HRF profile and the HRF difference between the 
# two groups. The term list(subject=~1) under the option -ranEff indicates the random effects for the 
# cross-individual variability in intercept. The number of thin plate spline bases was set to the default 
# K = 10. The option -qVars identifies quantitative variables (TR and age in this case plus dummy-coded 
# sex and group). The last two specifiers -prediction and -dataTable list one table for HRF prediction 
# and another for input data information, respectively. The input file "input.table" is structured in a 
# long data frame format:

subject age sex group TR  InputFile
s1      29   1    1   0   s1.Inc.b0.nii
s1      29   1    1   1   s1.Inc.b1.nii
s1      29   1    1   2   s1.Inc.b2.nii
s1      29   1    1   3   s1.Inc.b3.nii
s1      29   1    1   4   s1.Inc.b4.nii
...

# The following table as the input file "HRF.table" provides the specifications for predicted HRFs:

label   age   sex   group   TR
HV0.00   0     0     -1    0.00
HV0.25   0     0     -1    0.25
HV0.50   0     0     -1    0.50
...
BP0.00   0     0      1    0.00
BP0.25   0     0      1    0.25
BP0.50   0     0      1    0.50
...
